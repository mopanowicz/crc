#!/bin/bash

TLS_CRT=/svc-tls/tls.crt

if [[ -f $TLS_CRT ]]; then
  KEYTOOL=$(which keytool)
  if [ "$KEYTOOL" == "" ]; then
    KEYTOOL=$(find /layers -name "keytool")
  fi

  CACERTS_PASSWORD=${CACERTS_PASSWORD:-changeit}

  CERTS=$(grep 'END CERTIFICATE' $TLS_CRT | wc -l)
  for N in $(seq 0 $((CERTS - 1))); do
    ALIAS="pod-$N"
    cat $TLS_CRT |
      awk "n==$N { print }; /END CERTIFICATE/ {n++}" |
      $KEYTOOL -noprompt -import -cacerts -alias $ALIAS -storepass $CACERTS_PASSWORD
  done
fi
