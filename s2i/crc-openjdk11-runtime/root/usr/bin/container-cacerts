#!/bin/bash

KEYTOOL=$(which keytool)
if [ "$KEYTOOL" == "" ]; then
  KEYTOOL=$(find /layers -name "keytool")
fi
CACERTS_PASSWORD=${CACERTS_PASSWORD:-changeit}

function import() {
  PEM=$1
  PREFIX=$2
  
  csplit -s -z -f $PREFIX $PEM '/-----BEGIN CERTIFICATE-----/' '{*}'

  for i in `ls ${PREFIX}*`; do
    # echo $i
    $KEYTOOL -importcert -cacerts -alias $i -noprompt -storepass $CACERTS_PASSWORD -file $i
  done
}

PEM=/var/run/secrets/kubernetes.io/serviceaccount/ca.crt
if [[ -f $PEM ]]; then
  import $PEM "ca-"
fi

PEM=/var/run/secrets/kubernetes.io/serviceaccount/service-ca.crt
if [[ -f $PEM ]]; then
  import $PEM "svc-ca-"
fi
